

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Hinageshi">
  <meta name="keywords" content="">
  
  <title>笔记 bgfx - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/atom-one-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":25,"cursorChar":"","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["_slim",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":17057737,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Hinageshi的駄菓子屋</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archive
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/backGround.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="笔记 bgfx">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-30 20:43" pubdate>
        May 30, 2022
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      73
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">笔记 bgfx</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：November 21, 2022
                
              </p>
            
            <div class="markdown-body">
              <h2 id="序言"><a class="markdownIt-Anchor" href="#序言"></a> 序言</h2>
<p>  <a target="_blank" rel="noopener" href="https://github.com/bkaradzic/bgfx">bgfx</a> 是一个跨平台的渲染框架。它将 DX、GL、VK 等图形 API 封装成了统一的接口，抹除了这些 API 之间的差异性。这样我们在写渲染逻辑的时候就只需要调用这层 RHI 提供的 API 就好，而不需要关心程序实际上使用的是什么图形 API 了。</p>
<p><img src="/img/bgfx/uml.jpg" srcset="/img/loading.gif" lazyload alt="https://www.jianshu.com/p/cd11172668c2" /></p>
<p>bgfx 的使用通常可以从实现 <code>entry::AppI</code> 接口中</p>
<ul>
<li><code>virtual void init(int32_t _argc, const char* const* _argv, uint32_t _width, uint32_t _height)</code></li>
<li><code>virtual int shutdown()</code></li>
<li><code>virtual bool update()</code></li>
</ul>
<p>这三个纯虚函数开始。</p>
<h2 id="init"><a class="markdownIt-Anchor" href="#init"></a> init</h2>
<p>bgfx 初始化资源是用 <code>bgfx::Init</code> 存储初始化信息，通过 <code>bgfx::init()</code> 进行初始化的。</p>
<h3 id="bgfxinit-的声明"><a class="markdownIt-Anchor" href="#bgfxinit-的声明"></a> bgfx::init() 的声明</h3>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// @param[in] _init 初始化参数</span><br><span class="hljs-comment">// @returns 初始化是否成功</span><br><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">init</span><span class="hljs-params">(<span class="hljs-keyword">const</span> Init&amp; _init = &#123;&#125;)</span></span>;<br></code></pre></div></td></tr></table></figure>
<h3 id="init-结构体的声明"><a class="markdownIt-Anchor" href="#init-结构体的声明"></a> Init 结构体的声明</h3>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Init</span> &#123;</span><br>	<span class="hljs-built_in">Init</span>();<br><br>	<span class="hljs-comment">// RendererType::Enum 罗列了 bgfx 支持的所有图形 API 类型</span><br>	<span class="hljs-comment">// 每一个类型都对应了 libs/bgfx/src 目录下的一份渲染后端代码 .h/.cpp</span><br>	<span class="hljs-comment">// 如果设置为 RendererType::Count 则会自动选择一个最适合当前平台的 API</span><br>	RendererType::Enum type;<br><br>	<span class="hljs-comment">// 显卡供应商的 ID</span><br>	<span class="hljs-comment">//   - `BGFX_PCI_ID_NONE` - Autoselect adapter.</span><br>	<span class="hljs-comment">//   - `BGFX_PCI_ID_SOFTWARE_RASTERIZER` - Software rasterizer.</span><br>	<span class="hljs-comment">//   - `BGFX_PCI_ID_AMD` - AMD adapter.</span><br>	<span class="hljs-comment">//   - `BGFX_PCI_ID_INTEL` - Intel adapter.</span><br>	<span class="hljs-comment">//   - `BGFX_PCI_ID_NVIDIA` - nVidia adapter.</span><br>	<span class="hljs-keyword">uint16_t</span> vendorId;<br><br>	<span class="hljs-comment">// 如果同一供应商有两张显卡，那么可以用 deviceId 来指定用哪一张</span><br>	<span class="hljs-keyword">uint16_t</span> deviceId;<br><br>	<span class="hljs-comment">// 指定开启显卡特性的掩码</span><br>	<span class="hljs-keyword">uint64_t</span> capabilities;<br><br>	<span class="hljs-comment">// 开发期间打开，输出更多的调试信息到 Output 窗口</span><br>	<span class="hljs-keyword">bool</span> debug;<br>	<span class="hljs-keyword">bool</span> profile;<br><br>	<span class="hljs-comment">// 平台数据，包括 Native display type、Native window handle 等</span><br>	PlatformData platformData;<br><br>	<span class="hljs-comment">// 指定渲染目标的 FrameBuffer 的格式、大小、数量、刷新方式、帧延迟等</span><br>	<span class="hljs-comment">// init.resolution.reset = BGFX_RESET_VSYNC 代表开启垂直同步</span><br>	Resolution resolution;<br><br>	<span class="hljs-comment">// 可配置的运行时限制参数</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Limits</span> &#123;</span><br>		<span class="hljs-built_in">Limits</span>();<br><br>		<span class="hljs-keyword">uint16_t</span> maxEncoders;       <span class="hljs-comment">// 最大 command buffer 数量</span><br>		<span class="hljs-keyword">uint32_t</span> minResourceCbSize; <span class="hljs-comment">// 最小 command buffer 大小</span><br>		<span class="hljs-keyword">uint32_t</span> transientVbSize;   <span class="hljs-comment">// 最大 vertex buffer 大小</span><br>		<span class="hljs-keyword">uint32_t</span> transientIbSize;   <span class="hljs-comment">// 最大 index buffer 大小</span><br>	&#125;;		<br>	Limits limits;<br><br>	<span class="hljs-comment">// 回调接口</span><br>	CallbackI* callback;<br>	<br>	<span class="hljs-comment">// 指定一个自定义的内存分配器，bgfx 假设它是线程安全的</span><br>	bx::AllocatorI* allocator;<br>&#125;;<br></code></pre></div></td></tr></table></figure>
<h4 id="platformdata-结构体的声明"><a class="markdownIt-Anchor" href="#platformdata-结构体的声明"></a> PlatformData 结构体的声明</h4>
<p>所有成员变量都被声明为 <code>void*</code> 类型，以便接受各个平台各类型的数据对象。<br />
所有成员变量都被默认初始化为 NULL，此时 bgfx 会负责创建对应的对象。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PlatformData</span> &#123;</span><br>	<span class="hljs-built_in">PlatformData</span>();<br><br>	<span class="hljs-keyword">void</span>* ndt;<br>	<span class="hljs-keyword">void</span>* nwh;<br>	<span class="hljs-keyword">void</span>* context;<br>	<span class="hljs-keyword">void</span>* backBuffer;<br>	<span class="hljs-keyword">void</span>* backBufferDS;<br>&#125;;<br></code></pre></div></td></tr></table></figure>
<p>bgfx.cpp 中有一个全局的 <code>bgfx::g_platformData</code> 变量，可以通过 <code>void setPlatformData(const PlatformData&amp; _data);</code> 进行设置</p>
<h4 id="glcontext_xxx-文件"><a class="markdownIt-Anchor" href="#glcontext_xxx-文件"></a> glcontext_xxx 文件</h4>
<p>bgfx 中在各自平台的上下文文件中（glcontext_wgl.h，glcontext_egl.h 等）定义了一个 GlContext 类，类中有一个 m_context 的成员变量也是用来存储当前平台的 GL 上下文的。<br />
在调用 <code>GlContext:Create()</code> 时会去取全局变量 g_platformData 中的 context ，如果是空的，则创建各自平台的上下文环境，并赋值给 m_context 变量，此外，还会将 m_context 赋值给 g_internalData.context。</p>
<h3 id="bgfxsetdebug-的声明"><a class="markdownIt-Anchor" href="#bgfxsetdebug-的声明"></a> bgfx::setDebug() 的声明</h3>
<p>设置 Debug 相关的标志</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">//  @param[in] _debug 启用的标志</span><br><span class="hljs-comment">//    - `BGFX_DEBUG_IFH` - 无限快的硬件。当这个标志被设置时，所有的渲染调用将被跳过。</span><br><span class="hljs-comment">//       这在分析时很有用，可以快速评估 CPU 和 GPU 之间的潜在瓶颈。</span><br><span class="hljs-comment">//    - `BGFX_DEBUG_PROFILER` - 启用分析器</span><br><span class="hljs-comment">//    - `BGFX_DEBUG_STATS` - 显示内部统计数据</span><br><span class="hljs-comment">//    - `BGFX_DEBUG_TEXT` - 显示 Debug 文本</span><br><span class="hljs-comment">//    - `BGFX_DEBUG_WIREFRAME` - 线框渲染</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setDebug</span><span class="hljs-params">(<span class="hljs-keyword">uint32_t</span> _debug)</span></span>;<br></code></pre></div></td></tr></table></figure>
<h3 id="bgfxsetviewclear-的声明"><a class="markdownIt-Anchor" href="#bgfxsetviewclear-的声明"></a> bgfx::setViewClear() 的声明</h3>
<p>设置清屏相关的标志</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">//  @param[in] _id View id.</span><br><span class="hljs-comment">//  @param[in] _flags 清屏的标志</span><br><span class="hljs-comment">//    - BGFX_CLEAR_COLOR</span><br><span class="hljs-comment">//    - BGFX_CLEAR_DEPTH</span><br><span class="hljs-comment">//    - BGFX_CLEAR_STENCIL 等</span><br><span class="hljs-comment">//  @param[in] _rgba 颜色的新值</span><br><span class="hljs-comment">//  @param[in] _depth 深度的新值</span><br><span class="hljs-comment">//  @param[in] _stencil 模板的新值</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setViewClear</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">	ViewId _id,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">uint16_t</span> _flags,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">uint32_t</span> _rgba = <span class="hljs-number">0x000000ff</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">float</span> _depth = <span class="hljs-number">1.0f</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">uint8_t</span> _stencil = <span class="hljs-number">0</span></span></span><br><span class="hljs-params"><span class="hljs-function">	)</span></span>;<br></code></pre></div></td></tr></table></figure>
<h3 id="顶点"><a class="markdownIt-Anchor" href="#顶点"></a> 顶点</h3>
<p>以 example-01-cubes 为例</p>
<h4 id="poscolorvertex-结构体"><a class="markdownIt-Anchor" href="#poscolorvertex-结构体"></a> PosColorVertex 结构体</h4>
<p>顶点结构体的命名可以自定义。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PosColorVertex</span> &#123;</span><br>	<span class="hljs-keyword">float</span> m_x;<br>	<span class="hljs-keyword">float</span> m_y;<br>	<span class="hljs-keyword">float</span> m_z;<br>	<span class="hljs-keyword">uint32_t</span> m_abgr;<br><br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>		ms_layout<br>			.<span class="hljs-built_in">begin</span>() <span class="hljs-comment">// 返回对象自身的引用</span><br>			<span class="hljs-comment">// 前三个 float 作为坐标数据</span><br>			.<span class="hljs-built_in">add</span>(bgfx::Attrib::Position, <span class="hljs-number">3</span>, bgfx::AttribType::Float)<br>			<span class="hljs-comment">// 然后四个 Uint8 作为颜色数据，并归一化</span><br>			<span class="hljs-comment">// 归一化：只对定点生效，0-255 在 VertexShader 中为 0.0-1.0 </span><br>			.<span class="hljs-built_in">add</span>(bgfx::Attrib::Color0,   <span class="hljs-number">4</span>, bgfx::AttribType::Uint8, <span class="hljs-literal">true</span>)<br>			.<span class="hljs-built_in">end</span>(); <span class="hljs-comment">// 存储数据</span><br>	&#125;;<br><br>	<span class="hljs-keyword">static</span> bgfx::VertexLayout ms_layout;<br>&#125;;<br><br>bgfx::VertexLayout PosColorVertex::ms_layout;<br></code></pre></div></td></tr></table></figure>
<h4 id="实际的数据"><a class="markdownIt-Anchor" href="#实际的数据"></a> 实际的数据</h4>
<p>顶点数据</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">static</span> PosColorVertex s_cubeVertices[] = &#123;<br>	&#123;<span class="hljs-number">-1.0f</span>,  <span class="hljs-number">1.0f</span>,  <span class="hljs-number">1.0f</span>, <span class="hljs-number">0xff000000</span> &#125;,<br>	&#123; <span class="hljs-number">1.0f</span>,  <span class="hljs-number">1.0f</span>,  <span class="hljs-number">1.0f</span>, <span class="hljs-number">0xff0000ff</span> &#125;,<br>	<span class="hljs-comment">// ......</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>
<p>三角形顶点索引</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> s_cubeTriList[] = &#123;<br>	<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>,<br>	<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>,<br>	<span class="hljs-comment">// ......</span><br>&#125;;<br></code></pre></div></td></tr></table></figure>
<h4 id="创建-vertexbuffer-indexbuffer"><a class="markdownIt-Anchor" href="#创建-vertexbuffer-indexbuffer"></a> 创建 VertexBuffer、IndexBuffer</h4>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">PosColorVertex::<span class="hljs-built_in">init</span>();<br>m_vbh = bgfx::<span class="hljs-built_in">createVertexBuffer</span>(<br>	bgfx::<span class="hljs-built_in">makeRef</span>(s_cubeVertices, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(s_cubeVertices)), PosColorVertex::ms_layout<br>	);<br>m_ibh = bgfx::<span class="hljs-built_in">createIndexBuffer</span>(<br>	bgfx::<span class="hljs-built_in">makeRef</span>(s_cubeTriList, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(s_cubeTriList))<br>	);<br></code></pre></div></td></tr></table></figure>
<h5 id="handle"><a class="markdownIt-Anchor" href="#handle"></a> Handle</h5>
<p>在 bgfx 中每个 Buffer、Texture、Program 等都会有一个对应的 Handle 对象，并且通过 bgfx::creatXXX 接口来创建，这些接口基本都需要一个 makeRef 创建的对象。</p>
<h5 id="bgfxmakeref"><a class="markdownIt-Anchor" href="#bgfxmakeref"></a> bgfx::makeRef()</h5>
<p>makeRef 不会申请新的内存，他仅仅返回一个 <code>Memory *</code>，包含了原对象的指针和大小。<br />
同时在内部使用 <code>MemoryRef</code> 对象进行内存的管理，<code>MemoryRef</code> 存储了一个 <code>Memory</code>，一个删除器及其参数。<br />
这么做的好处是：可控且统一的内存管理方式，记录 size 大小以防丢失，多个 <code>MemoryRef</code> 可以对应同一份资源。<br />
缺点是：当原指针被释放时，<code>MemoryRef</code> 中存储的指针会成为悬垂指针。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">const</span> Memory *<span class="hljs-title">makeRef</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *_data, <span class="hljs-keyword">uint32_t</span> _size,</span></span><br><span class="hljs-params"><span class="hljs-function">	ReleaseFn _releaseFn, <span class="hljs-keyword">void</span> *_userData)</span> </span>&#123;<br>	MemoryRef *memRef = (MemoryRef *)<span class="hljs-built_in">BX_ALLOC</span>(g_allocator, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(MemoryRef));<br>	memRef-&gt;mem.size  = _size;<br>	memRef-&gt;mem.data  = (<span class="hljs-keyword">uint8_t</span> *)_data;<br>	memRef-&gt;releaseFn = _releaseFn;<br>	memRef-&gt;userData  = _userData;<br>	<span class="hljs-keyword">return</span> &amp;memRef-&gt;mem;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="注意"><a class="markdownIt-Anchor" href="#注意"></a> 注意</h4>
<p>bgfx 默认使用 16-bit 的顶点索引，这在实际的项目中是完全不够用的。强烈建议以 <code>uint32_t</code> 存储顶点索引，然后在调用 <code>bgfx::createIndexBuffer</code> 时打开对应的 flag。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">bgfx::<span class="hljs-built_in">createIndexBuffer</span>(bgfx::<span class="hljs-built_in">makeRef</span>(..., ...), BGFX_BUFFER_INDEX32);<br></code></pre></div></td></tr></table></figure>
<h3 id="program"><a class="markdownIt-Anchor" href="#program"></a> Program</h3>
<p>通过 Shader 创建 Program</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">m_program = <span class="hljs-built_in">loadProgram</span>(<span class="hljs-string">&quot;vs_cubes&quot;</span>, <span class="hljs-string">&quot;fs_cubes&quot;</span>);<br></code></pre></div></td></tr></table></figure>
<h4 id="shader"><a class="markdownIt-Anchor" href="#shader"></a> Shader</h4>
<p>上面 <code>loadProgram()</code> 读取的 Shader 是 <code>bgfx\examples\runtime\shaders\对应API</code> 下的 <code>.bin</code> 文件。这种文件是通过 bgfx 自制的 Shader 编译工具 <code>shaderc.exe</code> 生成的。bgfx 的各类工具都位于 tools 文件夹下。<br />
<a target="_blank" rel="noopener" href="https://bkaradzic.github.io/bgfx/tools.html#shader-compiler-shaderc">https://bkaradzic.github.io/bgfx/tools.html#shader-compiler-shaderc</a><br />
之后专门有一个小结来展开讲讲 bgfx 的 Shader。</p>
<h2 id="shutdown"><a class="markdownIt-Anchor" href="#shutdown"></a> shutdown</h2>
<ul>
<li>先 <code>imguiDestroy()</code></li>
<li>再 <code>bgfx::destroy()</code> 所有的 buffer 和 program</li>
<li>然后 <code>bgfx::shutdown()</code><br />
与 init 相对，在 <code>bgfx::shutdown()</code> 中会调用 <code>Context::shutdown()</code></li>
</ul>
<h2 id="update"><a class="markdownIt-Anchor" href="#update"></a> update</h2>
<h2 id="渲染流程"><a class="markdownIt-Anchor" href="#渲染流程"></a> 渲染流程</h2>
<p>（以使用 OpenGl 作为渲染 API 为例）</p>
<ul>
<li>对应平台的 entry.cpp 中 <code>entry::Context::run()</code> 调用</li>
<li>---- <code>bgfx::renderFrame()</code> 调用</li>
<li>------ <code>bgfx::Context::renderFrame()</code> 调用</li>
<li>-------- <code>bgfx::gl::RendererContextGL::submit()</code> 调用</li>
<li>---------- <strong><code>glDrawElementsInstanced()</code></strong></li>
<li>---------- <code>bgfx::blit()</code> 调用</li>
<li>------------ <code>bgfx::gl::RendererContextGL::blitRender()</code> 调用</li>
<li>-------------- <strong><code>glDrawElements()</code></strong></li>
</ul>
<h3 id="gldrawelementsinstanced-是如何在-submit-中被调用的"><a class="markdownIt-Anchor" href="#gldrawelementsinstanced-是如何在-submit-中被调用的"></a> <code>glDrawElementsInstanced()</code> 是如何在 <code>submit()</code> 中被调用的</h3>
<p>列出的代码是简化过的</p>
<h4 id="drawm_numindices-的设置"><a class="markdownIt-Anchor" href="#drawm_numindices-的设置"></a> draw.m_numIndices 的设置</h4>
<p>首先在 example 中调用 <code>bgfx::setIndexBuffer()</code>，这个函数有以下重载：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setIndexBuffer</span><span class="hljs-params">(IndexBufferHandle _handle)</span> </span>&#123;<br>	s_ctx-&gt;m_encoder0-&gt;<span class="hljs-built_in">setIndexBuffer</span>(_handle);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setIndexBuffer</span><span class="hljs-params">(IndexBufferHandle _handle, <span class="hljs-keyword">uint32_t</span> _firstIndex, <span class="hljs-keyword">uint32_t</span> _numIndices)</span> </span>&#123;<br>	s_ctx-&gt;m_encoder0-&gt;<span class="hljs-built_in">setIndexBuffer</span>(_handle, _firstIndex, _numIndices);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>他们分别会调用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Encoder::setIndexBuffer</span><span class="hljs-params">(IndexBufferHandle _handle)</span> </span>&#123;<br>	<span class="hljs-built_in">setIndexBuffer</span>(_handle, <span class="hljs-number">0</span>, UINT32_MAX);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Encoder::setIndexBuffer</span><span class="hljs-params">(IndexBufferHandle _handle,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">uint32_t</span> _firstIndex, <span class="hljs-keyword">uint32_t</span> _numIndices)</span> </span>&#123;<br>	<span class="hljs-built_in">BGFX_ENCODER</span>(<span class="hljs-built_in">setIndexBuffer</span>(_handle, ib, _firstIndex, _numIndices) );<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>最终会经由 <code>BGFX_ENCODER</code> 这个宏去调用 <code>bgfx::EncoderImpI::setIndexBuffer()</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setIndexBuffer</span><span class="hljs-params">(IndexBufferHandle _handle, <span class="hljs-keyword">const</span> IndexBuffer&amp; _ib,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">uint32_t</span> _firstIndex, <span class="hljs-keyword">uint32_t</span> _numIndices)</span> </span>&#123;<br>	m_draw.m_startIndex  = _firstIndex;<br>	m_draw.m_numIndices  = _numIndices;<br>	m_draw.m_indexBuffer = _handle;<br>	m_draw.m_submitFlags |= <span class="hljs-number">0</span> == (_ib.m_flags &amp; BGFX_BUFFER_INDEX32) ?<br>		BGFX_SUBMIT_INTERNAL_NONE : BGFX_SUBMIT_INTERNAL_INDEX32;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="drawm_numindices-的判断"><a class="markdownIt-Anchor" href="#drawm_numindices-的判断"></a> draw.m_numIndices 的判断</h4>
<p>在 <code>renderer_gl.cpp</code> line 1815</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// 使用一整块 IndexBuffer 进行绘制</span><br><span class="hljs-keyword">if</span> (UINT32_MAX == draw.m_numIndices) &#123;<br>	<span class="hljs-built_in">GL_CHECK</span>(<span class="hljs-built_in">glDrawElementsInstanced</span>(prim.m_type<br>		, numIndices<br>		, indexFormat<br>		, (<span class="hljs-keyword">void</span>*)<span class="hljs-number">0</span><br>		, draw.m_numInstances<br>		) );<br>&#125;<br><span class="hljs-comment">// 多个 drawcall 复用 IndexBuffer</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prim.m_min &lt;= draw.m_numIndices) &#123;<br>	<span class="hljs-comment">// 确保该次 drawcall 的索引数量能支持绘制当前选择的图元类型</span><br>	<span class="hljs-built_in">GL_CHECK</span>(<span class="hljs-built_in">glDrawElementsInstanced</span>(prim.m_type<br>		, numIndices<br>		, indexFormat<br>		<span class="hljs-comment">// 计算该次 drawcall 使用的 IndexBuffer 的起始位置</span><br>		, (<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">uintptr_t</span>)(draw.m_startIndex*indexSize)<br>		, draw.m_numInstances<br>		) );<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="bgfxblit-是如何在-submit-中被调用的"><a class="markdownIt-Anchor" href="#bgfxblit-是如何在-submit-中被调用的"></a> <code>bgfx::blit()</code> 是如何在 <code>submit()</code> 中被调用的</h3>
<h4 id="_render-m_debug-的设置"><a class="markdownIt-Anchor" href="#_render-m_debug-的设置"></a> _render-&gt;m_debug 的设置</h4>
<p>在 example 中调用 <code>bgfx::setDebug()</code> 即可。</p>
<h4 id="_render-m_debug-的判断"><a class="markdownIt-Anchor" href="#_render-m_debug-的判断"></a> _render-&gt;m_debug 的判断</h4>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (_render-&gt;m_debug &amp; (BGFX_DEBUG_IFH|BGFX_DEBUG_STATS) )&#123;<br>	<span class="hljs-built_in">blit</span>(<span class="hljs-keyword">this</span>, _textVideoMemBlitter, tvm);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="提交-drawcall-的几种方式"><a class="markdownIt-Anchor" href="#提交-drawcall-的几种方式"></a> 提交 DrawCall 的几种方式</h2>
<p>以 OpenGL 为例：<a target="_blank" rel="noopener" href="https://www.khronos.org/opengl/wiki/Vertex_Rendering">Vertex Rendering</a></p>
<h3 id="direct-rendering"><a class="markdownIt-Anchor" href="#direct-rendering"></a> Direct rendering</h3>
<h4 id="basic-drawing"><a class="markdownIt-Anchor" href="#basic-drawing"></a> Basic Drawing</h4>
<p><code>void glDrawArrays( GLenum mode​, GLint first​, GLsizei count​ );</code><br />
<code>void glDrawElements( GLenum mode​, GLsizei count​, GLenum type​, void * indices​ );</code></p>
<h4 id="multi-draw"><a class="markdownIt-Anchor" href="#multi-draw"></a> Multi-Draw</h4>
<p>只绑定/修改一次 VAO，多次 DrawCall。</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">glMultiDrawArrays</span><span class="hljs-params">( GLenum mode, GLint *first, GLsizei *count, GLsizei primcount )</span> </span>&#123;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; primcount; ++i)<br>		<span class="hljs-keyword">if</span> (count[i] &gt; <span class="hljs-number">0</span>)<br>			<span class="hljs-built_in">glDrawArrays</span>(mode, first[i], count[i]);<br>&#125;<br><span class="hljs-comment">// 或者</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">glMultiDrawElements</span><span class="hljs-params">( GLenum mode, GLsizei *count, GLenum type,</span></span><br><span class="hljs-params"><span class="hljs-function">	<span class="hljs-keyword">void</span> **indices, GLsizei primcount )</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; primcount; ++i)<br>		<span class="hljs-keyword">if</span> (count[i] &gt; <span class="hljs-number">0</span>)<br>			<span class="hljs-built_in">glDrawElements</span>(mode, count[i], type, indices[i]);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="instancing"><a class="markdownIt-Anchor" href="#instancing"></a> Instancing</h4>
<p>一次 DrawCall，绘制多个相同的物体，实例之间通过一个内建变量 <code>gl_InstanceID</code> 进行区分。<br />
可以使用该变量作为下标进行索引来获取每个实例需要的数据，也可以通过 <code>glVertexAttribDivisor()</code> 来设置顶点属性的更新方式。</p>
<h3 id="indirect-rendering"><a class="markdownIt-Anchor" href="#indirect-rendering"></a> Indirect rendering</h3>
<p>一次 DrawCall 发送多个绘制指令，这些指令的参数存储在缓冲区对象提供的 GPU 存储中。<br />
这样做的目的是允许 GPU 进程填充这些值，避免了 GPU-&gt;CPU-&gt;GPU 之间的往返。可以是一个计算着色器，可以是几何着色器加上 <a target="_blank" rel="noopener" href="https://www.khronos.org/opengl/wiki/Transform_Feedback">Transform Feedback</a>，或者一个 OpenCL/CUDA 进程。</p>
<h3 id="submit-里的实现"><a class="markdownIt-Anchor" href="#submit-里的实现"></a> submit() 里的实现</h3>
<p>在这个位置：<br />
<img src="/img/bgfx/submitDraw.png" srcset="/img/loading.gif" lazyload alt="" /></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// IndirectDraw</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">isValid</span>(draw.m_indirectBuffer))<br>	<span class="hljs-comment">// MultiDrawElements</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isValid</span>(draw.m_indexBuffer))<br>		<span class="hljs-built_in">glMultiDrawElementsIndirect</span>();<br>	<span class="hljs-comment">// MultiDrawArrays</span><br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-built_in">glMultiDrawArraysIndirect</span>();<br><span class="hljs-comment">// DirectDraw</span><br><span class="hljs-keyword">else</span><br>	<span class="hljs-comment">// DrawElements</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isValid</span>(draw.m_indexBuffer))<br>		<span class="hljs-comment">// 使用完整的 IndexBuffer 进行绘制</span><br>		<span class="hljs-keyword">if</span> (UINT32_MAX == draw.m_numIndices)<br>			<span class="hljs-built_in">glDrawElementsInstanced</span>();<br>		<span class="hljs-comment">// 复用 IndexBuffer</span><br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prim.m_min &lt;= draw.m_numIndices)<br>			<span class="hljs-built_in">glDrawElementsInstanced</span>();<br>	<span class="hljs-comment">// DrawArrays</span><br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-built_in">glDrawArraysInstanced</span>();<br></code></pre></div></td></tr></table></figure>
<h4 id="isvalid-与-handle"><a class="markdownIt-Anchor" href="#isvalid-与-handle"></a> isValid() 与 Handle</h4>
<p>bgfx 定义了 <code>BGFX_HANDLE</code> 宏来快速实现各类 Handle：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BGFX_HANDLE(_name)                                                           \</span><br><span class="hljs-meta">	struct _name &#123; uint16_t idx; &#125;;                                                  \</span><br><span class="hljs-meta">	inline bool isValid(_name _handle) &#123; return bgfx::kInvalidHandle != _handle.idx; &#125;</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BGFX_INVALID_HANDLE &#123; bgfx::kInvalidHandle &#125;</span><br></code></pre></div></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> kInvalidHandle = UINT16_MAX;<br><br><span class="hljs-built_in">BGFX_HANDLE</span>(DynamicIndexBufferHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(DynamicVertexBufferHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(FrameBufferHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(IndexBufferHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(IndirectBufferHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(OcclusionQueryHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(ProgramHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(ShaderHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(TextureHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(UniformHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(VertexBufferHandle)<br><span class="hljs-built_in">BGFX_HANDLE</span>(VertexLayoutHandle)<br></code></pre></div></td></tr></table></figure>
<h2 id="bgfxs-shader"><a class="markdownIt-Anchor" href="#bgfxs-shader"></a> bgfx’s Shader</h2>
<p><a target="_blank" rel="noopener" href="https://bkaradzic.github.io/bgfx/tools.html#shader-compiler-shaderc">shaderc</a><br />
bgfx 自定义了一种基于 GLSL 的 <code>.sc</code> 后缀的 ShaderLanguage，以下简称为 BSL。<br />
在编译 Shader 时，先将 BSL 通过一些预处理替换翻译成 GLSL 或者 HLSL，然后通过 <a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/glslang">glslang</a> 将 HLSL 编译成 SPIR-V，再通过 <a target="_blank" rel="noopener" href="https://github.com/KhronosGroup/SPIRV-Cross">SPIRV-Cross</a> 来逆向生成剩下的所有 ShaderLanguage。</p>
<h3 id="编译-shader"><a class="markdownIt-Anchor" href="#编译-shader"></a> 编译 Shader</h3>
<p><code>loadProgram()</code> 读取的 Shader 是位于 <code>bgfx\examples\runtime\shaders\对应API</code> 下的 <code>.bin</code> 文件。这种文件可以通过 <code>shaderc.exe</code> 编译 <code>.sc</code> 文件生成。</p>
<blockquote>
<p>shaderc 的实现，分两个阶段。<br />
1.预处理阶段（包括某些字符搜索替换）。2.编译阶段。<br />
其中预处理阶段是将 sc 源码转换成 glsl 或者 hlsl。就算有 5 个分支，预处理阶段也只输出两种语言。</p>
</blockquote>
<ul>
<li><code>--preprocess</code> 参数表示只进行预处理。</li>
<li><code>--raw</code> 参数表示不进行预处理和 GLSL 优化，直接接受 Shader 文件进行编译。</li>
<li><code>--define NAME1=VALUE1;NAME2=VALUE2</code> 用来给 Shader 添加预处理的宏定义。</li>
</ul>
<p>这里搭建一个简单的结构来完成这个工作：</p>
<ul>
<li>common
<ul>
<li>bgfx_shader.sh</li>
<li><a target="_blank" rel="noopener" href="http://common.sh">common.sh</a></li>
<li><a target="_blank" rel="noopener" href="http://shaderlib.sh">shaderlib.sh</a></li>
</ul>
</li>
<li>compiled</li>
<li>shader
<ul>
<li><a target="_blank" rel="noopener" href="http://varying.def.sc">varying.def.sc</a></li>
<li>vs_name.sc</li>
<li>fs_name.sc</li>
</ul>
</li>
<li>compile.bat</li>
<li>shaderc.exe</li>
</ul>
<ol>
<li>将 <a target="_blank" rel="noopener" href="http://common.sh">common.sh</a> 修改为 <code>#include &quot;bgfx_shader.sh&quot;</code> 直接把 <code>bgfx_shader.sh</code> 放在同一文件夹下。<br />
具体做法无所谓，只要能让每个 Shader 都在第一行包含到 <code>bgfx_shader.sh</code>和 <code>shaderlib.sh</code> 两个文件就行。<br />
1.1. <code>bgfx_shader.sh</code> 中是大量的宏定义，用于处理各类 Shader Language 之间的差异。<code>shaderlib.sh</code> 中是一些辅助函数，该文件并不是必须的。<br />
1.2.<code>bgfx_shader.sh</code> 中大致从 Line39 到 Line581 是 hlsl 侧的宏定义，从 Line583 到 Line623 是 glsl 侧的宏定义。宏嵌套了很多层，然后用缩进来整理，反正挺抽象的，不得不抱怨一下可读性太低了。<br />
1.3. 对于 ComputeShader 有一个同样重要的文件叫 <code>bgfx_compute.sh</code>，之后再说。<br />
1.4. 在 FragmentShader 中似乎也可以 <code>#include &quot;bgfx_compute.sh&quot;</code>，这时也可以用 <code>IMAG2D_WR</code> 和 <code>imageStore</code> 写入贴图，就像 FBO 和 MRT 一样。但是不能写 <code>NUM_THREADS</code> 了。详见 <code>example-21</code>。</li>
<li><code>shader</code> 文件夹内是所有的 Shader 文件以及一个必须的 <code>varying.def.sc</code>，用于测试的话随便去一个 example 里 copy 过来就行。</li>
<li><code>compile.bat</code> 的内容是：<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">set SHADER=<span class="hljs-string">&quot;shader&quot;</span><br>set COMPILED=<span class="hljs-string">&quot;compiled&quot;</span><br>md %COMPILED%<br>shaderc --type v --platform windows -p vs_5_0 -O <span class="hljs-number">3</span> --varyingdef %SHADER%/varying.def.sc -f %SHADER%/vs_name.sc -o %COMPILED%/vs_name.bin<br>shaderc --type f --platform windows -p ps_5_0 -O <span class="hljs-number">3</span> --varyingdef %SHADER%/varying.def.sc -f %SHADER%/fs_name.sc -o %COMPILED%/fs_name.bin<br>pause<br></code></pre></div></td></tr></table></figure>
修改 -p 参数即可编译为不同的目标 ShaderLanguage。可选的参数有：<a target="_blank" rel="noopener" href="https://github.com/bkaradzic/bgfx/blob/master/scripts/shader.mk">shader.mk</a></li>
<li>所有编译结果都保存在在 <code>compiled</code> 文件夹内。</li>
<li>实际使用中可能会写： <code>set DX11=&quot;../../runtime/shaders/dx11&quot;</code> 直接在对应路径下生成编译结果，这样方便一点。</li>
</ol>
<h3 id="编写-shader"><a class="markdownIt-Anchor" href="#编写-shader"></a> 编写 Shader</h3>
<p>BSL 和 GLSL 的区别：</p>
<ul>
<li>
<p>只允许 <code>float</code> 类型的 uniform 变量。</p>
</li>
<li>
<p>所有输入变量只能在 <code>main()</code> 中被访问。</p>
</li>
<li>
<p><code>SAMPLER2D/3D/CUBE/etc.</code> 取代了 <code>sampler2D/3D/Cube/etc.</code>。</p>
</li>
<li>
<p><code>vec2/3/4_splat(&lt;value&gt;)</code> 取代了只接受单个参数的 <code>vec2/3/4(&lt;value&gt;)</code>，接受多个参数的 <code>vec2/3/4</code> 构造函数依然有效。</p>
</li>
<li>
<p>使用 <code>mtxFromCols/mtxFromRows</code> 来构造矩阵，相同参数下，他们的结果互为转置。</p>
</li>
<li>
<p><code>mul(mat, vec)</code> 用于向量与矩阵的相乘。</p>
</li>
<li>
<p>必须且只能存在一份 <code>varying.def.sc</code>，用于声明所有 Shader 中输入/输出变量的语义和类型。</p>
</li>
<li>
<p>在 Shader 的开头需要使用 <code>$input/$output</code> 来声明输入/输出变量，这些变量名与 <code>varying.def.sc</code> 中的声明一一对应。</p>
</li>
<li>
<p>在 <a target="_blank" rel="noopener" href="https://github.com/bkaradzic/bgfx/blob/master/src/bgfx_shader.sh">bgfx_shader.sh</a> 中还定义了一些 bgfx 内建的 uniform 变量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp">uniform vec4 u_viewRect;<br>uniform vec4 u_viewTexel;<br>uniform mat4 u_view;<br>uniform mat4 u_invView;<br>uniform mat4 u_proj;<br>uniform mat4 u_invProj;<br>uniform mat4 u_viewProj;<br>uniform mat4 u_invViewProj;<br>uniform mat4 u_model[BGFX_CONFIG_MAX_BONES];<br>uniform mat4 u_modelView;<br>uniform mat4 u_modelViewProj;<br>uniform vec4 u_alphaRef4;<br></code></pre></div></td></tr></table></figure>
<p>我们只需要在用户线程中调用 <code>bgfx::setViewTransform</code> 以及 <code>bgfx::setTransform</code> 这样的接口，之后就可以直接在 Shader 中使用这些 uniform 变量了。</p>
<blockquote>
<p><code>bgfx::setViewTransform()</code> 会将内存 copy 进 <code>bgfx::FrameCache::m_matrixCache</code> 并且将其起始地址保存至 <code>bgfx::RenderDraw::m_startMatrix</code>。<br />
两者会在 <code>bgfx::ViewState::setPredefined</code> 模板函数中被读取，每个 case 会调用对应 <code>RenderContext</code> 的 <code>setShaderUniform4x4f</code>（定义在 render_xxx.cpp 中），每个渲染后端都会在自己的 <code>RenderContexXXX::Submit</code> 中调用 <code>setPredefined</code>。<br />
这个 <code>submit</code> 会在 <code>bgfx::Context::renderFrame</code> 中被调用，这个 <code>renderFrame</code> 会在对应平台的入口 <code>entry_XXX</code> 中被调用。</p>
</blockquote>
</li>
<li>
<p>在 cpu 端内存中以 <code>[0, 1, 2, 3, 4, 5, 6, 7, 8]</code> 形式存储的矩阵在 gpu 端会被理解为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable width="100%"><mtr><mtd width="50%"></mtd><mtd><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mtd><mtd width="50%"></mtd><mtd><mtext>(列主序)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">\left[
\begin{matrix}
0 &amp; 3 &amp; 6 \\
1 &amp; 4 &amp; 7 \\
2 &amp; 5 &amp; 8 
\end{matrix} \right]\tag{列主序}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05002em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-4.05002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span><span class="tag"><span class="strut" style="height:3.60004em;vertical-align:-1.55002em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord cjk_fallback">列</span><span class="mord cjk_fallback">主</span><span class="mord cjk_fallback">序</span></span><span class="mord">)</span></span></span></span></span></span></p>
</li>
<li>
<p>关于 <code>mul()</code>：</p>
<ol>
<li><code>mul(mat, vec)</code> 在 GLSL 里被替换成 <code>mat * vec</code>。</li>
<li>由于 bgfx 在 HLSL 中默认以 <code>float4x4</code>（列主序）定义矩阵，以及向量在 <code>mul()</code> 第二个参数时被视为列向量的特性，加上 bgfx 在 cpu 端不进行额外的矩阵转置，使得 <code>mul(mat, vec)</code> 在不同渲染后端可以表现出一致的行为。</li>
</ol>
</li>
<li>
<p>如果希望添加更多的内建 uniform 变量，比如 <code>model_inverse_transport</code>：</p>
<ol>
<li>在 <code>bgfx_p.h</code> 的 <code>PredefinedUniform</code> 结构体中添加自己的枚举。</li>
<li>在 <code>bgfx.cpp</code> 的 <code>s_predefinedName</code> 数组中添加 uniform 变量的名称。两者的顺序要一致，且枚举不能添加于 <code>PredefinedUniform::Enum::Count</code> 之后。</li>
<li>在 <code>renderer.h</code> 的 <code>setPredefined</code> 函数中添加新的 case。</li>
<li>如果用到了 cache，记得在 <code>bgfx::ViewState::reset()</code> 中重置它。</li>
<li>在 <code>bgfx_shader.sh</code> 中声明新的 uniform。命名要与 <code>s_predefinedName</code> 中一致。</li>
</ol>
</li>
<li>
<p>Shader 中的语义与顶点数据结构体中的 <code>bgfx::Attrib</code> 一一对应：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PosColorVertex</span> &#123;</span><br>	<span class="hljs-keyword">float</span> m_x;<br>	<span class="hljs-keyword">float</span> m_y;<br>	<span class="hljs-keyword">float</span> m_z;<br>	<span class="hljs-keyword">uint32_t</span> m_abgr;<br><br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>&#123;<br>		ms_layout<br>			.<span class="hljs-built_in">begin</span>()<br>			.<span class="hljs-built_in">add</span>(bgfx::Attrib::Position, <span class="hljs-number">3</span>, bgfx::AttribType::Float)<br>			.<span class="hljs-built_in">add</span>(bgfx::Attrib::Color0,   <span class="hljs-number">4</span>, bgfx::AttribType::Uint8, <span class="hljs-literal">true</span>)<br>			.<span class="hljs-built_in">end</span>();<br>	&#125;;<br><br>	<span class="hljs-keyword">static</span> bgfx::VertexLayout ms_layout;<br>&#125;;<br></code></pre></div></td></tr></table></figure>
<p><code>Attrib</code> 结构体的定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Attrib</span> &#123;</span><br>	<span class="hljs-comment">/// Corresponds to vertex shader attribute.</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Enum</span> &#123;</span><br>		Position,  <span class="hljs-comment">//!&lt; a_position</span><br>		Normal,    <span class="hljs-comment">//!&lt; a_normal</span><br>		Tangent,   <span class="hljs-comment">//!&lt; a_tangent</span><br>		Bitangent, <span class="hljs-comment">//!&lt; a_bitangent</span><br>		Color0,    <span class="hljs-comment">//!&lt; a_color0</span><br>		Color1,    <span class="hljs-comment">//!&lt; a_color1</span><br>		Color2,    <span class="hljs-comment">//!&lt; a_color2</span><br>		Color3,    <span class="hljs-comment">//!&lt; a_color3</span><br>		Indices,   <span class="hljs-comment">//!&lt; a_indices</span><br>		Weight,    <span class="hljs-comment">//!&lt; a_weight</span><br>		TexCoord0, <span class="hljs-comment">//!&lt; a_texcoord0</span><br>		TexCoord1, <span class="hljs-comment">//!&lt; a_texcoord1</span><br>		TexCoord2, <span class="hljs-comment">//!&lt; a_texcoord2</span><br>		TexCoord3, <span class="hljs-comment">//!&lt; a_texcoord3</span><br>		TexCoord4, <span class="hljs-comment">//!&lt; a_texcoord4</span><br>		TexCoord5, <span class="hljs-comment">//!&lt; a_texcoord5</span><br>		TexCoord6, <span class="hljs-comment">//!&lt; a_texcoord6</span><br>		TexCoord7, <span class="hljs-comment">//!&lt; a_texcoord7</span><br>		Count<br>	&#125;;<br>&#125;;<br></code></pre></div></td></tr></table></figure>
</li>
</ul>
<h3 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h3>
<ul>
<li>不要使用隐式的类型转换，Shader 将无法编译为 GLSL。</li>
<li>尽量不要使用下标访问矩阵，这会在不同的 Shader Language 中产生不同的行为（GLSL 取矩阵的列，HLSL 取矩阵的行）。<br />
为了解决这种差异性，bgfx 在 <code>bgfx_shader.sh</code> 中十分“<strong>贴心</strong>”地提供了 <code>instMul(a, b)</code> 函数，该函数在 HLSL 下返回 <code>mul(b, a)</code> 在 GLSL 下返回 <code>mul(a, b)</code>。<br />
使得我们可以用这种写法在几种 Shader Language 中得到一致的表现：<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// vec4() 代指任意一个四分量向量。</span><br>mat4 tmpMat;<br>tmpMat[<span class="hljs-number">0</span>] = <span class="hljs-built_in">vec4</span>();<br>tmpMat[<span class="hljs-number">1</span>] = <span class="hljs-built_in">vec4</span>();<br>tmpMat[<span class="hljs-number">2</span>] = <span class="hljs-built_in">vec4</span>();<br>tmpMat[<span class="hljs-number">3</span>] = <span class="hljs-built_in">vec4</span>();<br>vec4 tmpVec = <span class="hljs-built_in">instMul</span>(<span class="hljs-built_in">vec4</span>(), tmpMat);<br></code></pre></div></td></tr></table></figure>
我个人还是建议直接使用 <code>mtxFromRows</code> 和 <code>mul</code> 之类的函数从线性代数的角度去看待矩阵啦。</li>
<li>在函数外声明与初始化变量时尽量加上 <code>static</code> 关键字。<br />
<a target="_blank" rel="noopener" href="https://github.com/CatDogEngine/CatDogEngine/issues/17">[shaderc] Not same standard for optimization #17</a></li>
</ul>
<h3 id="相关链接"><a class="markdownIt-Anchor" href="#相关链接"></a> 相关链接</h3>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/61361628">shaderc 编译工具和 sc 源文件</a><br />
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/X-Jun/p/9808727.html">DirectX11–HLSL 中矩阵的内存布局和 mul 函数探讨</a><br />
<a target="_blank" rel="noopener" href="http://www.cppblog.com/Leaf/archive/2010/12/28/137588.html">HLSL 中的 MUL 指令深层剖析</a></p>
<h2 id="bgfxs-texture"><a class="markdownIt-Anchor" href="#bgfxs-texture"></a> bgfx’s Texture</h2>
<p><a target="_blank" rel="noopener" href="https://bkaradzic.github.io/bgfx/tools.html#texture-compiler-texturec">texturec</a><br />
与 Shader 类似，<code>loadTexture(&quot;textures/name.dds&quot;);</code> 读取的文件也是经过 texturec 编码之后的贴图。</p>
<h3 id="编码-texture"><a class="markdownIt-Anchor" href="#编码-texture"></a> 编码 Texture</h3>
<ul>
<li>
<p>texturec 支持的所有文件格式：<br />
<img src="/img/bgfx/format.png" srcset="/img/loading.gif" lazyload alt="" /></p>
</li>
<li>
<p>使用 <code>texturec --formats</code> 指令可以看到 texturec 支持的所有编码格式:</p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">TextureFormat</span></span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-comment">/// Texture formats:</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Enum</span></span><br><span class="hljs-class">	&#123;</span><br>		BC1,          <span class="hljs-comment">//!&lt; DXT1</span><br>		BC2,          <span class="hljs-comment">//!&lt; DXT3</span><br>		BC3,          <span class="hljs-comment">//!&lt; DXT5</span><br>		BC4,          <span class="hljs-comment">//!&lt; LATC1/ATI1</span><br>		BC5,          <span class="hljs-comment">//!&lt; LATC2/ATI2</span><br>		BC6H,         <span class="hljs-comment">//!&lt; BC6H</span><br>		BC7,          <span class="hljs-comment">//!&lt; BC7</span><br>		ETC1,         <span class="hljs-comment">//!&lt; ETC1 RGB8</span><br>		ETC2,         <span class="hljs-comment">//!&lt; ETC2 RGB8</span><br>		ETC2A,        <span class="hljs-comment">//!&lt; ETC2 RGBA8</span><br>		ETC2A1,       <span class="hljs-comment">//!&lt; ETC2 RGB8A1</span><br>		PTC12,        <span class="hljs-comment">//!&lt; PVRTC1 RGB 2BPP</span><br>		PTC14,        <span class="hljs-comment">//!&lt; PVRTC1 RGB 4BPP</span><br>		PTC12A,       <span class="hljs-comment">//!&lt; PVRTC1 RGBA 2BPP</span><br>		PTC14A,       <span class="hljs-comment">//!&lt; PVRTC1 RGBA 4BPP</span><br>		PTC22,        <span class="hljs-comment">//!&lt; PVRTC2 RGBA 2BPP</span><br>		PTC24,        <span class="hljs-comment">//!&lt; PVRTC2 RGBA 4BPP</span><br>		ATC,          <span class="hljs-comment">//!&lt; ATC RGB 4BPP</span><br>		ATCE,         <span class="hljs-comment">//!&lt; ATCE RGBA 8 BPP explicit alpha</span><br>		ATCI,         <span class="hljs-comment">//!&lt; ATCI RGBA 8 BPP interpolated alpha</span><br>		ASTC4x4,      <span class="hljs-comment">//!&lt; ASTC 4x4 8.0 BPP</span><br>		ASTC5x5,      <span class="hljs-comment">//!&lt; ASTC 5x5 5.12 BPP</span><br>		ASTC6x6,      <span class="hljs-comment">//!&lt; ASTC 6x6 3.56 BPP</span><br>		ASTC8x5,      <span class="hljs-comment">//!&lt; ASTC 8x5 3.20 BPP</span><br>		ASTC8x6,      <span class="hljs-comment">//!&lt; ASTC 8x6 2.67 BPP</span><br>		ASTC10x5,     <span class="hljs-comment">//!&lt; ASTC 10x5 2.56 BPP</span><br>  <br>		Unknown,      <span class="hljs-comment">// Compressed formats above.</span><br>  <br>		R1,<br>		A8,<br>		R8,<br>		R8I,<br>		R8U,<br>		R8S,<br>		R16,<br>		R16I,<br>		R16U,<br>		R16F,<br>		R16S,<br>		R32I,<br>		R32U,<br>		R32F,<br>		RG8,<br>		RG8I,<br>		RG8U,<br>		RG8S,<br>		RG16,<br>		RG16I,<br>		RG16U,<br>		RG16F,<br>		RG16S,<br>		RG32I,<br>		RG32U,<br>		RG32F,<br>		RGB8,<br>		RGB8I,<br>		RGB8U,<br>		RGB8S,<br>		RGB9E5F,<br>		BGRA8,<br>		RGBA8,<br>		RGBA8I,<br>		RGBA8U,<br>		RGBA8S,<br>		RGBA16,<br>		RGBA16I,<br>		RGBA16U,<br>		RGBA16F,<br>		RGBA16S,<br>		RGBA32I,<br>		RGBA32U,<br>		RGBA32F,<br>		R5G6B5,<br>		RGBA4,<br>		RGB5A1,<br>		RGB10A2,<br>		RG11B10F,<br>  <br>		UnknownDepth, <span class="hljs-comment">// Depth formats below.</span><br>  <br>		D16,<br>		D24,<br>		D24S8,<br>		D32,<br>		D16F,<br>		D24F,<br>		D32F,<br>		D0S8,<br>  <br>		Count<br>	&#125;;<br>&#125;;<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>格式方面有一些注意事项：</p>
<ul>
<li><code>.png</code> 只接受 <code>RGBA8F</code> 的非压缩格式。</li>
<li><code>.exr</code> 只接受 <code>RGBA16F</code> 的非压缩格式。</li>
<li>不支持 <code>ATC</code> 的输出。</li>
<li>几乎不支持 <code>PVRTC</code> 的输出。</li>
<li>不支持带 alpha 通道的 <code>ETC</code> 输出.</li>
<li><code>BC4</code> 单通道，<code>BC5</code> 双通道。</li>
</ul>
</li>
<li>
<p>-m 生成 MipMap（体积会刚好增加 1/3）。</p>
<ul>
<li><code>.exr</code>, <code>.hdr</code> 和 <code>.png</code> 不支持生成 MipMap。</li>
</ul>
</li>
<li>
<p><code>--max &lt;max size&gt;</code> 限制长/宽的最大值。</p>
</li>
<li>
<p>根据 <code>-q &lt;d/h/f&gt;</code> 选项来平衡编码的质量与速度。</p>
</li>
<li>
<p><code>--linear</code> 输入输出都是线性，不应用伽马矫正。</p>
</li>
<li>
<p><code>-n/--normal</code> 设置会默认认为贴图是线性的。</p>
</li>
<li>
<p>texturec 还能通过 <code>--radiance &lt;model&gt;</code> 选项来对 Cube Map 做滤波生成一系列的 Radiance Map，可选的参数有：<code>Phong</code>, <code>PhongBrdf</code>, <code>Blinn</code>, <code>BlinnBrdf</code> 和 <code>GGX</code>。<br />
默认接受的是 CubeMap，如果输入是 2:1 的 Lat Long 需要加上 <code>--equirect</code> 参数。</p>
</li>
<li>
<p>如果贴图处于 sRGB 空间，<code>LoadTexture</code> 在读取 CubeMap 的时候是不支持 <code>BGFX_TEXTURE_SRGB</code> 的 flag 的，CubeMap 只能在 Shader 里用 <code>toLinear</code> 转至线性空间。</p>
</li>
<li>
<p>贴两个简单的脚本，我们假设带 <code>roughness</code> 文件名的贴图是合并了多通道数据的贴图，更多的 texture type 需要自己实现一下新的分支：</p>
</li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs py"><span class="hljs-keyword">import</span> os<br><br>texture  = <span class="hljs-string">&quot;textures/&quot;</span><br>compiled = <span class="hljs-string">&quot;compiled/&quot;</span><br><br>baseColor = <span class="hljs-string">&quot;aseColor&quot;</span><br>normal    = <span class="hljs-string">&quot;ormal&quot;</span><br>roughness = <span class="hljs-string">&quot;oughness&quot;</span><br>decal     = <span class="hljs-string">&quot;ecal&quot;</span><br><br><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> os.listdir(texture):<br>	<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;compiling : &quot;</span>+file)<br>	textureName = os.path.splitext(file)[<span class="hljs-number">0</span>]<br>	textureType = os.path.splitext(file)[<span class="hljs-number">1</span>]<br>	<span class="hljs-keyword">if</span> baseColor <span class="hljs-keyword">in</span> file:<br>		os.system(<span class="hljs-string">&quot;texturec -f &quot;</span>+texture+textureName+textureType+<span class="hljs-string">&quot; -o &quot;</span>+compiled+textureName+<span class="hljs-string">&quot;.dds -t BC3 -m -q h --max 1024&quot;</span>)<br>	<span class="hljs-keyword">elif</span> normal <span class="hljs-keyword">in</span> file:<br>		os.system(<span class="hljs-string">&quot;texturec -f &quot;</span>+texture+textureName+textureType+<span class="hljs-string">&quot; -o &quot;</span>+compiled+textureName+<span class="hljs-string">&quot;.dds -t BC3 -m -q h --max 1024 -n&quot;</span>)<br>	<span class="hljs-keyword">elif</span> roughness <span class="hljs-keyword">in</span> file:<br>		os.system(<span class="hljs-string">&quot;texturec -f &quot;</span>+texture+textureName+textureType+<span class="hljs-string">&quot; -o &quot;</span>+compiled+textureName+<span class="hljs-string">&quot;.dds -t BC3 -m -q h --max 1024 --linear&quot;</span>)<br>	<span class="hljs-keyword">elif</span> decal <span class="hljs-keyword">in</span> file:<br>		os.system(<span class="hljs-string">&quot;texturec -f &quot;</span>+texture+textureName+textureType+<span class="hljs-string">&quot; -o &quot;</span>+compiled+textureName+<span class="hljs-string">&quot;.dds -t BC3 -m -q h --max 1024&quot;</span>)<br>	<span class="hljs-keyword">else</span>:<br>		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Undeclared texture type!\n&quot;</span>)<br></code></pre></div></td></tr></table></figure>
<figure class="highlight bat"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bat"><span class="hljs-built_in">echo</span> off<br><br><span class="hljs-built_in">set</span> textures=&quot;textures&quot;<br><span class="hljs-built_in">set</span> compiled=&quot;compiled&quot;<br><br><span class="hljs-built_in">set</span> baseColor=&quot;aseColor&quot;<br><span class="hljs-built_in">set</span> normal=&quot;ormal&quot;<br><span class="hljs-built_in">set</span> roughness=&quot;oughness&quot;<br><span class="hljs-built_in">set</span> decal=&quot;ecal&quot;<br><br><span class="hljs-keyword">IF</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXIST</span> <span class="hljs-variable">%compiled%</span> <span class="hljs-built_in">MD</span> <span class="hljs-variable">%compiled%</span><br><br><br><span class="hljs-keyword">for</span> <span class="hljs-variable">%%i</span> <span class="hljs-keyword">in</span> (<span class="hljs-variable">%textures%</span>/*.*) <span class="hljs-keyword">do</span> (<br>	<span class="hljs-built_in">echo</span> compiling : <span class="hljs-variable">%%i</span><br>	<span class="hljs-built_in">echo</span> <span class="hljs-variable">%%i</span>|<span class="hljs-built_in">findstr</span> <span class="hljs-variable">%baseColor%</span>&gt;<span class="hljs-built_in">nul</span> &amp;&amp; (<br>		texturec -f <span class="hljs-variable">%textures%</span>/<span class="hljs-variable">%%i</span> -o <span class="hljs-variable">%compiled%</span>/<span class="hljs-variable">%%~</span>ni.dds -t BC3 -m -q h --max <span class="hljs-number">1024</span><br>	)<br>	<span class="hljs-built_in">echo</span> <span class="hljs-variable">%%i</span>|<span class="hljs-built_in">findstr</span> <span class="hljs-variable">%normal%</span>&gt;<span class="hljs-built_in">nul</span> &amp;&amp; (<br>		texturec -f <span class="hljs-variable">%textures%</span>/<span class="hljs-variable">%%i</span> -o <span class="hljs-variable">%compiled%</span>/<span class="hljs-variable">%%~</span>ni.dds -t BC3 -m -q h --max <span class="hljs-number">1024</span> -n<br>	)<br>	<span class="hljs-built_in">echo</span> <span class="hljs-variable">%%i</span>|<span class="hljs-built_in">findstr</span> <span class="hljs-variable">%roughness%</span>&gt;<span class="hljs-built_in">nul</span> &amp;&amp; (<br>		texturec -f <span class="hljs-variable">%textures%</span>/<span class="hljs-variable">%%i</span> -o <span class="hljs-variable">%compiled%</span>/<span class="hljs-variable">%%~</span>ni.dds -t BC3 -m -q h --max <span class="hljs-number">1024</span> --linear<br>	)<br>	<span class="hljs-built_in">echo</span> <span class="hljs-variable">%%i</span>|<span class="hljs-built_in">findstr</span> <span class="hljs-variable">%decal%</span>&gt;<span class="hljs-built_in">nul</span> &amp;&amp; (<br>		texturec -f <span class="hljs-variable">%textures%</span>/<span class="hljs-variable">%%i</span> -o <span class="hljs-variable">%compiled%</span>/<span class="hljs-variable">%%~</span>ni.dds -t BC3 -m -q h --max <span class="hljs-number">1024</span><br>	)<br>)<br><span class="hljs-built_in">pause</span><br></code></pre></div></td></tr></table></figure>
<h3 id="压缩-texture"><a class="markdownIt-Anchor" href="#压缩-texture"></a> 压缩 Texture</h3>
<p>不同压缩格式之间的区别，不同平台上压缩格式的选择：<br />
<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Av411K7bt?p=2">纹理压缩——包体瘦身术</a><br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/ynnmnm/article/details/44983545">常用纹理和纹理压缩格式</a><br />
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/401111461">UE4 中的纹理压缩</a><br />
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kekec/p/11909187.html">像素格式与纹理压缩</a><br />
<a target="_blank" rel="noopener" href="https://docs.unity3d.com/2021.3/Documentation/Manual/class-TextureImporterOverride.html">Recommended, default, and supported texture formats, by platform</a><br />
<a target="_blank" rel="noopener" href="https://developer.nvidia.com/astc-texture-compression-for-game-assets">Using ASTC Texture Compression for Game Assets</a><br />
<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/uwp/graphics-concepts/texture-block-compression">Texture block compression</a></p>
<h2 id="bgfxs-model"><a class="markdownIt-Anchor" href="#bgfxs-model"></a> bgfx’s Model</h2>
<p>模型的编码和读取同理，内容不多，看官方文档就好：<br />
<a target="_blank" rel="noopener" href="https://bkaradzic.github.io/bgfx/tools.html#geometry-compiler-geometryc">Geometry Compiler</a></p>
<h2 id="mrt"><a class="markdownIt-Anchor" href="#mrt"></a> MRT</h2>
<h3 id="setviewclear"><a class="markdownIt-Anchor" href="#setviewclear"></a> setViewClear</h3>
<p>今天看到一个重载：<br />
<img src="/img/bgfx/setViewClear.png" srcset="/img/loading.gif" lazyload alt="bgfx.h Line 3392" /></p>
<blockquote>
<p>Set view clear flags with different clear color for each frame buffer texture. Must use <code>bgfx::setPaletteColor</code> to setup clear color palette.</p>
</blockquote>
<p><code>bgfx::setViewClear</code> 调用 <code>bgfx::Context::setViewClear</code> 调用 <code>bgfx::View::setClear</code> 调用 <code>ngfx::Clear::Set</code> 给 <code>ngfx::Clear::m_index</code> 赋值，查找一下该变量的所有引用，转到了 <code>renderer_xxx.cpp</code> 里，比如 <code>bgfx::gl::RendererContextGL::clearQuad</code>，在使用 palette 的情况下 <code>m_index</code> 作为多个索引去取调色盘中的颜色，否则前四个 <code>m_index</code> 直接作为 rgba。<br />
结合使用 <code>void setPaletteColor(uint8_t _index, uint32_t _rgba)</code> 即可对不同的 rt 设置不同的清屏颜色。<br />
最多有 16 个调色盘：<code>#define BGFX_CONFIG_MAX_COLOR_PALETTE 16</code></p>
<h2 id="相关链接-2"><a class="markdownIt-Anchor" href="#相关链接-2"></a> 相关链接</h2>
<p><a target="_blank" rel="noopener" href="https://t-rvw.github.io/blog/2022/05/28/game_engine_rhi/">自制游戏引擎 - 图形API</a><br />
<a target="_blank" rel="noopener" href="https://bkaradzic.github.io/bgfx/">bgfx 文档</a><br />
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/59452545">跨平台渲染引擎之路：bgfx 分析</a><br />
<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/72736611">跨平台渲染引擎之路：bgfx 再分析与启程</a><br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/android_wql/article/details/85044252">bgfx从入门到没有放弃</a><br />
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/SmileSFL/p/15949639.html">BGFX多线程渲染</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/CPP/">CPP</a>
                    
                      <a class="hover-with-bg" href="/tags/RHI/">RHI</a>
                    
                      <a class="hover-with-bg" href="/tags/bgfx/">bgfx</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/22/cppLatest/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">C++ 随记</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/05/01/GAMES104andEStar/">
                        <span class="hidden-mobile">笔记 GAMES104 & E 星计划</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"5e2153d92606f0f30050","clientSecret":"71138048e7eacddcadcf14ce72f87fe12fa35c40","repo":"Hinageshi01.github.io","owner":"Hinageshi01","admin":["Hinageshi01"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '85a7e9d4dc91420ab528eb5d3179e60a'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <br/> 本站内容依据 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> 许可证进行授权 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.10/dist/katex.min.css" />
  











<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
